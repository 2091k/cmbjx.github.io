---
layout: post
title: "BarTender打印数据保存成Excel"
subtitle: ""
author: "晴天，微冷"
header-img: "img/tu/home-blue.jpg"
header-mask: 0.4
category: 技术
tags:
- BarTender
- Excel
---

#### 使用VB代码直接实现

<!-- 高安全版：AES加密保护，修复UTF-8解密错误 -->
<div id="bartender-aes-container" style="margin: 20px 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
  <!-- 密码输入区域 -->
  <div id="bartender-aes-prompt" style="padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; margin-bottom: 10px;">
    <p style="margin: 0 0 10px 0; color: #333; font-size: 14px;">请输入密码查看代码：</p>
    <input 
      type="password" 
      id="bartender-aes-pwd" 
      placeholder="输入密码"
      style="padding: 8px 12px; width: 250px; border: 1px solid #ddd; border-radius: 4px; margin-right: 8px; font-size: 14px;"
      onkeydown="if(event.key === 'Enter') decryptBartenderCode()"
    >
    <button 
      onclick="decryptBartenderCode()"
      style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;"
    >
      解密并查看代码
    </button>
    <p style="margin: 8px 0 0 0; color: #6c757d; font-size: 12px;">提示：输入密码后按回车或点击按钮均可验证</p>
  </div>
  
  <!-- 解密后显示代码的容器（默认空） -->
  <div id="bartender-aes-code-container" style="display: none;">
    <pre style="margin: 0; padding: 16px; background: #f5f5f5; border-radius: 6px; overflow-x: auto;">
      <code class="language-vb" id="bartender-decrypted-code" style="color: #333; font-family: Consolas, Monaco, 'Courier New', monospace; font-size: 14px; line-height: 1.5;"></code>
    </pre>
  </div>
</div>

<!-- 引入AES加密库（CryptoJS） -->
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
<script>
// ===================== 核心配置（可自定义） =====================
// 1. 你的解密密码（可改成自己的，比如"bt2026"）
const DECRYPT_PASSWORD = "236520";
// 2. AES加密的密钥和向量（必须和加密工具中的一致！）
const AES_KEY = CryptoJS.enc.Utf8.parse("1234567890123456"); // 16位密钥
const AES_IV = CryptoJS.enc.Utf8.parse("abcdefghijklmnop");  // 16位向量
// 3. 替换为加密工具生成的真实密文（★★★关键修改处★★★）
const ENCRYPTED_VB_CODE = "gbdY474sRKBCEb7+LN5Bn8FRfMx7nXLP44A0KmwBeaJ7qrxeFPJ//9aBLlJY1x4CuyKW+EIe2XGDvmoiUJu6uMzPpdDSNVjVnQ83WrU4rNVspAESsraiJxgdzurJgWgthf41BIZWnwpcE7yBsVjq+luioGZlItVS+lRByIWk7FQ9V7PoWfLEGWWXVAF1s/CdrqbcFaO0tGGHTr4sLWRyw5rNVXoRmSAfjHhGSa1nVfsMDOePl7ZRbRhKgmHif3iycRZJYftundjBcd5y6oq2007Ymp+7zbFJpWLe3L1AgzygXMpRovDg83oymVoklSzBNu2uixEEBTq2KTv6EKqZJuZ2s8H3wBiW2b7Um+zeG6ij5+AQzM/UDZ5ot/LW5t980y387/DYtmtuTfic1syzicoOn/HK5xCQRHfEQ5hEyTqCELkkwvLYmDGzh6bRQHsaDoHQwY82PThPusyHJ0nTq88/22CAMNh3KRnWUgg0eQxugxTiXLH7f9bBNZr6KGQ9o1fm8TmhYFu7jgftpXwC+0eolGjWkwVZFsq7IxrxFY4EP/GsgVVsUqXVneBg2Vgru8KgFzFVoJNY+dM3/c1oP2+znlLDO16y1mMOhsLmA9YqsN2B/wU/JmlXKJnCxGT99Zj4yY8gMdFFseM77oUG5hMKfS+RJnXOnSsbriHDAVUPH2SUm09T1rt0vVoPv3Fqk1nBU1pkAzOrZIFuAKtzz7jzrRUif9gEIETp1Dx7aJJMavxwrWJDWRACee4xHoRddsZlEqu0PwaN3YBap6z0sG2OJITX27Yad46Kwxwd/RufwgKQBsHJ6T15mFE0mTQDrOhEV9sZ9GvNtMFljFPl8JZAVaJW4v3Q0NvQRNhtbbgDc+WVIJn/5DFwaQe73tFzEYrXTGpACTmDzBdQhh3MpL5raVp42MbyXEQFgrNKJrjy2P7BeDP9yFjRa0f/slgdroFGKW7Fs6OvyWeCQPVE3JtgXY/YGKaF3HBoBDGS0Jw9MM7FnjbRScVGn4TPqr6IRncTtqfK+er7DVplYekm6E9TU5CciiEzLbrmP0NiIJ5lf+a+a2XXeE+tjKwutOIpAsKDYlFrksDHlxjw5dOkJEDueW7rdBMDuSS8t3vrcOGdRRgrg8KM4U9COtE//fJhgGID+E+kIZ/IAq+Zg3rXmtfl0P4AclUW1B8dkHfhFkXvCGE3BAUwYqXvcdEmoaM/xa+k41yg3AZIrUAumy+SIxD1kVDiJEvpbkdn3Zvgb9QceWwryiKI+z7hYzjzLIeiX2Jskliif2jrRh2G/0k84kilx3o5Fkfj9Bd/qQNJMHEY+qwAuWsEVvwHBRA4QYYhx0YlWVISlbKA+fWDHLp3FqpDUdBTA86FhvpV8Hka3Jkepay8dtsCyOcjCGLwcLtKJHKJ0XmwwjtX8Qr/S+t1lTXGOEjMh2ltP/s+VaVaXTPa/QEmLpGBMYER79MNrNcNS1dHrxHz7btTU26TvL/jvkadhcGKVOmQl5fPT2d3DXFdud7pGXs3zawnOqg/swxhX5a6YWwF67oe9FaWKhmGWmMkLhUyj9xD/YHMpF25e5lOuMoquVYkvgwwZSYZY4q1VZz/b+JspT3MzEgDJm3HrjjT6y0OYs5BuDlZhxdAooXlVQfcgvFWuqkaUX01Y0+Ub1j3wAgBNfj8LSAQc+q28QJ7+gib8IlCZyHU1X+LjPYkgrY1JiZ/H36MqSGgdH9TpEnIopNYJwnuY4e1B4f5PKnzqyy5PYRrIRwgK5JjfeGsYfPTOQQKvMnNWro8W3OM+/P1QJFYSEIPNAe84AYOwDAz5/8TYnXTlou8wcCj7W4CrIV8BRUJKCUzmD0LMAwdciRb6UpvXmzUW5l0K8udo+R5re+Lg++KyvTvOVgB3tvXOSbhDvmUHmw35JdYZV3lDyqAgH3bxdQOsiurIW0TZL2dh0N+4V7HokG6xgJromV/U2IKRK0B+KUbWgEJsQPkNBuL6ts2QeNt6zxiHt4YOtqA6K9IukBrdsFQRkeTH5lpQGfD4eahVcCRtqBJ5CAQd2waCfgKW5/4pQQJJDStgfMvKaLbeg+1YMCbm4O1BtcRUhVXt/m8fkJ2SyQf4VNIlLFTiEhqJw2YJruJdrzxnl5j+BlsWyDS6owezLNsqZcsBdWyonJzcL6DzEKcdNv+KuLuYtrnaLq2Ah41gdXppSl6tymPmRQNXR9jt9zik7ywePyL3KEbnG63f2a8IphMPQKfFGjglcYMjT6f2ithElzpwtqeGteS6oZnn6tvYIdbpr24HEMFIApSXGdTfFHbfH5QCNKflDP4WxMpV2CrcySHgXZG/lRdN2caAjbz+QdvUQCONQAnvRq5EsxpgVMSPJNIhMOGsG2JuMphFNoDpDXy5wOsrEA/xrPnzQuHwdhPWr8oXZ1AqpygJOwg7aLvxky271k/ZuGdGqDzBJBm5i+udfgCgdK0uAo/I3luSLKVV6EJHTr2L0LW4RMp4NBmh1FIYqzhm2iXRRIy0G4R/m25t2WV6pGDf+KNSJ9nzptY6v1F+d+ZAjHTax+qGFGlpvHODk+GmoTVfgg1rqCzkQs0tG3PSxoJN0rINYvK09LioLpK6SvQs8nYebtOvp4SttPVyxxUN+MnSpp2UxsyLKLqyIEYp23KG6td29yLQKDe1Rls54iH0Xjzwtycy/D/EfatqCWeoGsYzP79e+pA8mvqBe5T/qUB42xyXM9wIOnNpZmwuZgsqrrgs0yzxQNEFvbWa8Ddsh7cY4VNQhzZVOGtijdwTehHL7V/J7v7Sljs3N++AK51OXoUTquF7IJNqaILDcXNT8ykhaNF2waD9i+CpBxHSB4biDA6RXHSEtikPabZS4IVlB7GQ0dtAU9lHm+1uswsfuR7A2lkkIfc3A2QFwlWAHZUyWY9bbFGst5b2WOQJVmGldbcq2dpWIldVjWZ7lMGM4ZjYe+PCl4t2oWEeBGtrP8UyudMAZAx+AmsMqhpEU4e+1NOW+37BwGD";

// ===================== 解密核心函数（修复UTF-8错误） =====================
function decryptBartenderCode() {
  const pwdInput = document.getElementById("bartender-aes-pwd");
  const inputPwd = pwdInput.value.trim();
  
  // 1. 空密码验证
  if (inputPwd === "") {
    alert("请输入密码后再验证！");
    pwdInput.focus();
    return;
  }
  
  // 2. 密码验证
  if (inputPwd !== DECRYPT_PASSWORD) {
    alert("❌ 密码错误！请重新输入");
    pwdInput.value = "";
    pwdInput.focus();
    return;
  }
  
  try {
    // 3. AES解密密文（增加编码容错）
    const cipherParams = CryptoJS.lib.CipherParams.create({
      ciphertext: CryptoJS.enc.Base64.parse(ENCRYPTED_VB_CODE)
    });
    const decrypted = CryptoJS.AES.decrypt(cipherParams, AES_KEY, {
      iv: AES_IV,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    });
    // 修复UTF-8解码：先转成Latin1再转UTF-8
    const originalVBCode = CryptoJS.enc.Latin1.stringify(decrypted);
    
    // 4. 验证解密结果
    if (!originalVBCode || originalVBCode.length < 10) {
      throw new Error("密文无效或解密结果为空");
    }
    
    // 5. 显示解密后的代码（转义HTML特殊字符，避免渲染异常）
    const escapedCode = originalVBCode.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    document.getElementById("bartender-decrypted-code").textContent = originalVBCode;
    document.getElementById("bartender-aes-code-container").style.display = "block";
    document.getElementById("bartender-aes-prompt").style.display = "none";
    alert("✅ 密码正确！已解密并显示完整的代码");
    
  } catch (error) {
    alert("❌ 解密失败：" + error.message + "\n请检查：1.密文是否正确 2.密钥/向量是否匹配");
    pwdInput.value = "";
    pwdInput.focus();
  }
}

// 页面加载后自动聚焦输入框
window.onload = function() {
  document.getElementById("bartender-aes-pwd").focus();
};
</script>

#### 注意⚠️：具名数据源改成对应名称

脚本事件：OnNewRecord 读取数据库记录之后在打印时执行
