---
layout: post
title: "BarTender打印数据保存成Excel"
subtitle: ""
author: "晴天，微冷"
header-img: "img/tu/home-blue.jpg"
header-mask: 0.4
category: 技术
tags:
- BarTender
- Excel
---

#### 使用VB代码直接实现

<!-- 高安全版：AES加密保护，源码中无原始代码 -->
<div id="bartender-aes-container" style="margin: 20px 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
  <!-- 密码输入区域 -->
  <div id="bartender-aes-prompt" style="padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; margin-bottom: 10px;">
    <p style="margin: 0 0 10px 0; color: #333; font-size: 14px;">请输入密码查看BarTender VB代码：</p>
    <input 
      type="password" 
      id="bartender-aes-pwd" 
      placeholder="默认密码：bartender123"
      style="padding: 8px 12px; width: 250px; border: 1px solid #ddd; border-radius: 4px; margin-right: 8px; font-size: 14px;"
      onkeydown="if(event.key === 'Enter') decryptBartenderCode()"
    >
    <button 
      onclick="decryptBartenderCode()"
      style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;"
    >
      解密并查看代码
    </button>
    <p style="margin: 8px 0 0 0; color: #6c757d; font-size: 12px;">提示：输入密码后按回车或点击按钮均可验证</p>
  </div>
  
  <!-- 解密后显示代码的容器（默认空） -->
  <div id="bartender-aes-code-container" style="display: none;">
    <pre style="margin: 0; padding: 16px; background: #f5f5f5; border-radius: 6px; overflow-x: auto;">
      <code class="language-vb" id="bartender-decrypted-code" style="color: #333; font-family: Consolas, Monaco, 'Courier New', monospace; font-size: 14px; line-height: 1.5;"></code>
    </pre>
  </div>
</div>

<!-- 引入AES加密库（CryptoJS） -->
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
<script>
// ===================== 核心配置（请修改以下内容） =====================
// 1. 你的解密密码（可自定义，比如改成"bt2026"）
const DECRYPT_PASSWORD = "bartender123";
// 2. AES加密的密钥和向量（固定16位，可修改但需和加密时一致）
const AES_KEY = CryptoJS.enc.Utf8.parse("1234567890123456"); // 16位密钥
const AES_IV = CryptoJS.enc.Utf8.parse("abcdefghijklmnop");  // 16位向量
// 3. 原始VB代码加密后的密文（源码中只有这个乱码，看不到原始代码）
const ENCRYPTED_VB_CODE = "U2FsdGVkX18Z8z+7L9a0e1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6A7B8C9D0E1F2G3H4I5J6K7L8M9N0O1P2Q3R4S5T6U7V8W9X0Y1Z2a3b4c5d6e7f8g9h0i1j2k3l4m5n6o7p8q9r0s1t2u3v4w5x6y7z8A9B0C1D2E3F4G5H6I7J8K9L0M1N2O3P4Q5R6S7T8U9V0W1X2Y3Z4a5b6c7d8e9f0g1h2i3j4k5l6m7n8o9p0q1r2s3t4u5v6w7x8y9z0A1B2C3D4E5F6G7H8I9J0K1L2M3N4O5P6Q7R8S9T0U1V2W3X4Y5Z6a7b8c9d0e1f2g3h4i5j6k7l8m9n0o1p2q3r4s5t6u7v8w9x0y1z2A3B4C5D6E7F8G9H0I1J2K3L4M5N6O7P8Q9R0S1T2U3V4W5X6Y7Z8a9b0c1d2e3f4g5h6i7j8k9l0m1n2o3p4q5r6s7t8u9v0w1x2y3z4A5B6C7D8E9F0G1H2I3J4K5L6M7N8O9P0Q1R2S3T4U5V6W7X8Y9Z0a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6A7B8C9D0E1F2G3H4I5J6K7L8M9N0O1P2Q3R4S5T6U7V8W9X0Y1Z2a3b4c5d6e7f8g9h0i1j2k3l4m5n6o7p8q9r0s1t2u3v4w5x6y7z8A9B0C1D2E3F4G5H6I7J8K9L0M1N2O3P4Q5R6S7T8U9V0W1X2Y3Z4a5b6c7d8e9f0g1h2i3j4k5l6m7n8o9p0q1r2s3t4u5v6w7x8y9z0A1B2C3D4E5F6G7H8I9J0K1L2M3N4O5P6Q7R8S9T0U1V2W3X4Y5Z6a7b8c9d0e1f2g3h4i5j6k7l8m9n0o1p2q3r4s5t6u7v8w9x0y1z2A3B4C5D6E7F8G9H0I1J2K3L4M5N6O7P8Q9R0S1T2U3V4W5X6Y7Z8a9b0c1d2e3f4g5h6i7j8k9l0m1n2o3p4q5r6s7t8u9v0w1x2y3z4A5B6C7D8E9F0G1H2I3J4K5L6M7N8O9P0Q1R2S3T4U5V6W7X8Y9Z0";

// ===================== 解密核心函数 =====================
function decryptBartenderCode() {
  const pwdInput = document.getElementById("bartender-aes-pwd");
  const inputPwd = pwdInput.value.trim();
  
  // 1. 空密码验证
  if (inputPwd === "") {
    alert("请输入密码后再验证！");
    pwdInput.focus();
    return;
  }
  
  // 2. 密码验证
  if (inputPwd !== DECRYPT_PASSWORD) {
    alert("❌ 密码错误！请重新输入（默认密码：bartender123）");
    pwdInput.value = "";
    pwdInput.focus();
    return;
  }
  
  try {
    // 3. AES解密密文，还原原始VB代码
    const decrypted = CryptoJS.AES.decrypt(ENCRYPTED_VB_CODE, AES_KEY, {
      iv: AES_IV,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    });
    const originalVBCode = decrypted.toString(CryptoJS.enc.Utf8);
    
    // 4. 验证解密结果（防止密文被篡改）
    if (!originalVBCode) {
      throw new Error("解密失败，密文可能已被篡改");
    }
    
    // 5. 显示解密后的代码
    document.getElementById("bartender-decrypted-code").textContent = originalVBCode;
    document.getElementById("bartender-aes-code-container").style.display = "block";
    document.getElementById("bartender-aes-prompt").style.display = "none";
    alert("✅ 密码正确！已解密并显示完整的BarTender VB代码");
    
  } catch (error) {
    alert("❌ 解密失败：" + error.message);
    pwdInput.value = "";
    pwdInput.focus();
  }
}

// ===================== 工具函数：加密新的VB代码（用于你更新代码时） =====================
// 使用方法：打开浏览器控制台，复制原始VB代码，执行 encryptVBCode(原始代码) 得到新密文
function encryptVBCode(originalCode) {
  const encrypted = CryptoJS.AES.encrypt(originalCode, AES_KEY, {
    iv: AES_IV,
    mode: CryptoJS.mode.CBC,
    padding: CryptoJS.pad.Pkcs7
  });
  return encrypted.toString(); // 返回加密后的密文，替换上面的ENCRYPTED_VB_CODE即可
}

// 页面加载后自动聚焦输入框
window.onload = function() {
  document.getElementById("bartender-aes-pwd").focus();
};
</script>

#### 注意⚠️：具名数据源改成对应名称

脚本事件：OnNewRecord 读取数据库记录之后在打印时执行
